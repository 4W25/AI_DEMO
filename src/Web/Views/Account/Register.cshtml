@{
    ViewData["Title"] = "註冊";
}

<div class="hold-transition register-page">
<div class="register-box">
  <div class="register-logo">
    <b>AI_DEMO</b> 系統
  </div>

  <div class="card">
    <div class="card-body register-card-body">
      <p class="login-box-msg">註冊新會員</p>

      <form id="registerForm">
        <div class="input-group mb-3">
          <input type="text" id="username" class="form-control" placeholder="帳號" required>
          <div class="input-group-append">
            <div class="input-group-text">
              <span class="fas fa-user"></span>
            </div>
          </div>
        </div>
        <div class="input-group mb-3">
          <input type="email" id="email" class="form-control" placeholder="電子郵件" required>
          <div class="input-group-append">
            <div class="input-group-text">
              <span class="fas fa-envelope"></span>
            </div>
          </div>
        </div>
        <div class="input-group mb-3">
          <input type="password" id="password" class="form-control" placeholder="密碼" required>
          <div class="input-group-append">
            <div class="input-group-text">
              <span class="fas fa-lock"></span>
            </div>
          </div>
        </div>
        <div class="input-group mb-3">
          <input type="password" id="confirmPassword" class="form-control" placeholder="確認密碼" required>
          <div class="input-group-append">
            <div class="input-group-text">
              <span class="fas fa-lock"></span>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-8">
            <div class="icheck-primary">
              <input type="checkbox" id="agreeTerms" required>
              <label for="agreeTerms">
                我同意 <a href="#">條款</a>
              </label>
            </div>
          </div>
          <!-- /.col -->
          <div class="col-4">
            <button type="submit" class="btn btn-primary btn-block">註冊</button>
          </div>
          <!-- /.col -->
        </div>
      </form>

      <a href="/Account/Login" class="text-center">我已經有會員資格</a>
    </div>
    <!-- /.form-box -->
  </div><!-- /.card -->
</div>
<!-- /.register-box -->

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#registerForm').validate({
                rules: {
                    username: {
                        required: true,
                        minlength: 3,
                        maxlength: 50,
                        pattern: /^[a-zA-Z0-9_]+$/
                    },
                    email: {
                        required: true,
                        email: true
                    },
                    password: {
                        required: true,
                        minlength: 8,
                        pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/
                    },
                    confirmPassword: {
                        required: true,
                        equalTo: '#password'
                    },
                    agreeTerms: {
                        required: true
                    }
                },
                messages: {
                    username: {
                        required: '請輸入帳號',
                        minlength: '帳號長度至少 3 字元',
                        maxlength: '帳號長度不可超過 50 字元',
                        pattern: '帳號僅允許英數字與底線'
                    },
                    email: {
                        required: '請輸入電子郵件',
                        email: '請輸入有效的電子郵件地址'
                    },
                    password: {
                        required: '請輸入密碼',
                        minlength: '密碼長度至少 8 字元',
                        pattern: '密碼必須包含大小寫字母與數字'
                    },
                    confirmPassword: {
                        required: '請確認密碼',
                        equalTo: '密碼確認必須與密碼相同'
                    },
                    agreeTerms: {
                        required: '請同意條款'
                    }
                },
                errorPlacement: function(error, element) {
                    error.insertAfter(element);
                },
                submitHandler: function(form) {
                    var username = $('#username').val();
                    var email = $('#email').val();
                    var password = $('#password').val();

                    // 呼叫 /api/users 建立使用者
                    $.ajax({
                        url: '/api/users',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            username: username,
                            email: email,
                            password: password,
                            role: 2 // 預設 User
                        }),
                        success: function(response) {
                            toastr.success('註冊成功！請登入。');
                            window.location.href = '/Account/Login';
                        },
                        error: function(xhr) {
                            toastr.error('註冊失敗：' + xhr.responseJSON?.message || '未知錯誤');
                        }
                    });
                }
            });
        });
    </script>
}